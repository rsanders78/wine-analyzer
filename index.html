<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Wine Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #000;
        color: #fff;
        overflow-x: hidden;
        padding-bottom: 80px;
    }

    .header {
        padding: 20px;
        background: #000;
        border-bottom: 1px solid #222;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header h1 {
        font-size: 24px;
        font-weight: 600;
    }

    .header p {
        font-size: 14px;
        color: #888;
        margin-top: 4px;
    }

    .history-btn {
        background: #1a1a1a;
        border: 1px solid #333;
        color: #fff;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
    }

    .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .adventure-card {
        background: #111;
        border-radius: 16px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid #222;
    }

    .adventure-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
    }

    .adventure-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 16px;
    }

    .adventure-option {
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 12px;
        padding: 16px 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .adventure-option.active {
        background: #fff;
        color: #000;
        border-color: #fff;
    }

    .option-emoji {
        font-size: 24px;
        margin-bottom: 4px;
    }

    .option-label {
        font-size: 13px;
        font-weight: 600;
    }

    .preferences-box {
        background: #0a0a0a;
        border-radius: 12px;
        padding: 16px;
    }

    .preferences-box h3 {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #888;
        text-transform: uppercase;
    }

    .wine-types {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .wine-type-label {
        font-size: 11px;
        color: #666;
        margin-bottom: 4px;
        text-transform: uppercase;
    }

    .wine-type {
        font-size: 13px;
        color: #ccc;
        line-height: 1.6;
    }

    .camera-btn {
        width: 100%;
        background: #fff;
        color: #000;
        border: none;
        border-radius: 16px;
        padding: 20px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin: 20px 0 12px;
    }

    .camera-btn:active {
        transform: scale(0.98);
    }

    .camera-btn svg {
        width: 24px;
        height: 24px;
    }

    .upload-btn {
        background: #1a1a1a;
        color: #fff;
        border: 1px solid #333;
    }

    .page-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 20px 0 16px;
    }

    .page-thumbnail {
        position: relative;
        aspect-ratio: 3/4;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #333;
    }

    .page-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .page-number {
        position: absolute;
        top: 4px;
        left: 4px;
        background: rgba(0,0,0,0.7);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .remove-page {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(255,0,0,0.8);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 16px;
        cursor: pointer;
    }

    .page-actions {
        display: flex;
        gap: 8px;
    }

    .btn-analyze {
        flex: 2;
        background: #fff;
        color: #000;
        border: none;
        border-radius: 12px;
        padding: 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-add-more {
        flex: 1;
        background: #1a1a1a;
        color: #fff;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
    }

    #videoContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 1000;
        display: none;
    }

    #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .page-counter {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(10px);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        pointer-events: none;
    }

    .camera-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 30px 20px;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
    }

    .capture-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: #fff;
        border: 4px solid #000;
        cursor: pointer;
    }

    .done-btn {
        background: #0f3;
        color: #000;
        border: none;
        border-radius: 12px;
        padding: 12px 24px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
    }

    .close-camera {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0,0,0,0.5);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 24px;
        cursor: pointer;
    }

    .loading-card {
        background: #111;
        border-radius: 16px;
        padding: 40px 20px;
        text-align: center;
        margin: 20px 0;
        border: 1px solid #222;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #222;
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .wine-card {
        background: #111;
        border-radius: 16px;
        padding: 20px;
        margin: 12px 0;
        border: 1px solid #222;
    }

    .wine-rank {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
    }

    .rank-badge {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fff, #ddd);
        color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        flex-shrink: 0;
    }

    .rank-badge.top1 { background: linear-gradient(135deg, #ffd700, #ffed4e); }
    .rank-badge.top2 { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); }
    .rank-badge.top3 { background: linear-gradient(135deg, #cd7f32, #e8b67e); }

    .wine-info h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .wine-meta {
        font-size: 13px;
        color: #888;
        margin-bottom: 2px;
    }

    .wine-price {
        font-size: 20px;
        font-weight: 700;
        margin-top: 8px;
    }

    .wine-bars {
        margin: 16px 0;
    }

    .bar-item {
        margin-bottom: 12px;
    }

    .bar-label {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #888;
        margin-bottom: 4px;
        text-transform: uppercase;
    }

    .bar-track {
        height: 6px;
        background: #1a1a1a;
        border-radius: 3px;
        overflow: hidden;
    }

    .bar-fill {
        height: 100%;
        border-radius: 3px;
    }

    .bar-quality { background: #fff; }
    .bar-value { background: #0f3; }

    .wine-why {
        font-size: 14px;
        color: #aaa;
        line-height: 1.6;
        padding-top: 12px;
        border-top: 1px solid #1a1a1a;
    }

    .section-header {
        font-size: 13px;
        font-weight: 600;
        color: #888;
        margin: 24px 0 12px;
        text-transform: uppercase;
    }

    .error-card {
        background: #1a0000;
        border: 1px solid #330000;
        border-radius: 16px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
        color: #ff4444;
    }

    input[type="file"] {
        display: none;
    }
</style>
```

</head>
<body>
    <div class="header">
        <div>
            <h1>Wine Analyzer</h1>
            <p>Find the best value</p>
        </div>
        <button class="history-btn" id="historyBtn">History</button>
    </div>

```
<div class="container">
    <div class="adventure-card">
        <div class="adventure-title">Adventure Mode</div>
        
        <div class="adventure-options">
            <div class="adventure-option active" data-level="1">
                <div class="option-emoji">üõ°Ô∏è</div>
                <div class="option-label">Safe</div>
            </div>
            <div class="adventure-option" data-level="2">
                <div class="option-emoji">üß≠</div>
                <div class="option-label">Curious</div>
            </div>
            <div class="adventure-option" data-level="3">
                <div class="option-emoji">üó∫Ô∏è</div>
                <div class="option-label">Explorer</div>
            </div>
        </div>

        <div class="preferences-box">
            <h3 id="preferencesTitle">Safe includes</h3>
            <div class="wine-types">
                <div>
                    <div class="wine-type-label">Reds</div>
                    <div class="wine-type" id="redsList">Pinot Noir, Gamay</div>
                </div>
                <div>
                    <div class="wine-type-label">Whites</div>
                    <div class="wine-type" id="whitesList">Chablis, Sancerre</div>
                </div>
            </div>
        </div>
    </div>

    <div id="uploadSection">
        <button class="camera-btn" id="cameraBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Capture Wine List
        </button>
        <button class="camera-btn upload-btn" id="uploadBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Upload Photos
        </button>
        <input type="file" accept="image/*" multiple id="fileInput">
    </div>

    <div id="capturedSection"></div>
    <div id="loadingSection"></div>
    <div id="errorSection"></div>
    <div id="resultsSection"></div>
</div>

<div id="videoContainer">
    <button class="close-camera" id="closeCamera">√ó</button>
    <div class="page-counter" id="pageCounter">Page 1</div>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    
    <div class="camera-controls">
        <button class="done-btn" id="doneBtn" style="display:none;">Done</button>
        <button class="capture-btn" id="captureBtn"></button>
    </div>
</div>

<script>
    const adventureLevels = {
        1: {
            label: "Safe",
            reds: ['pinot noir', 'gamay', 'burgundy', 'beaujolais', 'chinon'],
            whites: ['chablis', 'sancerre', 'gruner veltliner', 'gr√ºner veltliner', 'muscadet'],
            boost: 1.2
        },
        2: {
            label: "Curious",
            reds: ['pinot noir', 'gamay', 'grenache', 'barbera', 'dolcetto', 'valpolicella'],
            whites: ['chablis', 'sancerre', 'albari√±o', 'verdicchio', 'soave', 'chenin blanc'],
            boost: 1.1
        },
        3: {
            label: "Explorer",
            reds: ['tempranillo', 'rioja', 'nebbiolo', 'sangiovese', 'syrah', 'monastrell'],
            whites: ['viognier', 'roussanne', 'chardonnay', 'semillon', 'vouvray'],
            boost: 1.0
        }
    };

    let currentAdventureLevel = 1;
    let stream = null;
    let capturedPages = [];

    document.querySelectorAll('.adventure-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.adventure-option').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            currentAdventureLevel = parseInt(this.dataset.level);
            updateAdventureDisplay();
        });
    });

    function updateAdventureDisplay() {
        const level = adventureLevels[currentAdventureLevel];
        document.getElementById('preferencesTitle').textContent = `${level.label} includes`;
        document.getElementById('redsList').textContent = level.reds.slice(0, 2).join(', ');
        document.getElementById('whitesList').textContent = level.whites.slice(0, 2).join(', ');
    }

    document.getElementById('cameraBtn').addEventListener('click', openCamera);
    document.getElementById('uploadBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    document.getElementById('closeCamera').addEventListener('click', closeCamera);
    document.getElementById('captureBtn').addEventListener('click', capturePhoto);
    document.getElementById('doneBtn').addEventListener('click', finishCapturing);

    async function openCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            
            document.getElementById('video').srcObject = stream;
            document.getElementById('videoContainer').style.display = 'block';
            updatePageCounter();
        } catch (err) {
            alert('Camera access denied. Please use upload option.');
        }
    }

    function closeCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        document.getElementById('videoContainer').style.display = 'none';
        document.getElementById('doneBtn').style.display = 'none';
    }

    function updatePageCounter() {
        document.getElementById('pageCounter').textContent = `Page ${capturedPages.length + 1}`;
    }

    function capturePhoto() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        canvas.toBlob((blob) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                capturedPages.push(e.target.result);
                updatePageCounter();
                document.getElementById('doneBtn').style.display = 'block';
                displayCapturedPages();
            };
            reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.95);
    }

    function finishCapturing() {
        closeCamera();
        document.getElementById('uploadSection').style.display = 'none';
    }

    function handleFileUpload(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                capturedPages.push(e.target.result);
                displayCapturedPages();
            };
            reader.readAsDataURL(file);
        });
        document.getElementById('uploadSection').style.display = 'none';
    }

    function displayCapturedPages() {
        const html = `
            <div class="page-grid">
                ${capturedPages.map((page, i) => `
                    <div class="page-thumbnail">
                        <img src="${page}" alt="Page ${i+1}">
                        <div class="page-number">${i+1}</div>
                        <button class="remove-page" onclick="removePage(${i})">√ó</button>
                    </div>
                `).join('')}
            </div>
            <div class="page-actions">
                <button class="btn-analyze" onclick="analyzeAllPages()">Analyze ${capturedPages.length} Page${capturedPages.length > 1 ? 's' : ''}</button>
                <button class="btn-add-more" onclick="addMorePages()">+ More</button>
            </div>
        `;
        document.getElementById('capturedSection').innerHTML = html;
    }

    function removePage(index) {
        capturedPages.splice(index, 1);
        if (capturedPages.length === 0) {
            resetApp();
        } else {
            displayCapturedPages();
        }
    }

    function addMorePages() {
        document.getElementById('fileInput').click();
    }

    function resetApp() {
        capturedPages = [];
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('capturedSection').innerHTML = '';
        document.getElementById('resultsSection').innerHTML = '';
        document.getElementById('errorSection').innerHTML = '';
        document.getElementById('fileInput').value = '';
    }

    async function analyzeAllPages() {
        document.getElementById('loadingSection').innerHTML = `
            <div class="loading-card">
                <div class="spinner"></div>
                <div style="font-size:15px;margin-bottom:8px;">Analyzing ${capturedPages.length} page${capturedPages.length > 1 ? 's' : ''}...</div>
                <div style="font-size:13px;color:#666;">This may take a moment</div>
            </div>
        `;
        document.getElementById('errorSection').innerHTML = '';
        document.getElementById('resultsSection').innerHTML = '';

        try {
            const imageContents = capturedPages.map((img, i) => ({
                type: 'image',
                source: {
                    type: 'base64',
                    media_type: 'image/jpeg',
                    data: img.split(',')[1]
                }
            }));

            const level = adventureLevels[currentAdventureLevel];
            const prompt = `Extract ALL wines from these wine list images. For each wine identify: name, producer, region, vintage, price, classification (Grand Cru, Premier Cru, etc).
```

Then analyze based on:

- Appellation hierarchy (village/1er cru/grand cru)
- Producer reputation
- Vintage quality for that region
- User preference (boost wines matching: ${level.reds.join(‚Äô, ‚Äò)}, ${level.whites.join(‚Äô, ‚Äô)})

Return ONLY the TOP 5 wines ranked by VALUE FOR MONEY (not absolute prestige). Keep reasoning SHORT and PRACTICAL.

Format as JSON:
[{
‚Äúrank‚Äù: 1,
‚Äúname‚Äù: ‚ÄúWine Name‚Äù,
‚Äúproducer‚Äù: ‚ÄúProducer‚Äù,
‚Äúregion‚Äù: ‚ÄúRegion‚Äù,
‚Äúvintage‚Äù: ‚Äú2020‚Äù,
‚Äúprice‚Äù: ‚Äú45.00‚Äù,
‚Äúclassification‚Äù: ‚ÄúGrand Cru‚Äù,
‚ÄúqualityScore‚Äù: 85,
‚ÄúvalueScore‚Äù: 90,
‚Äúwhy‚Äù: ‚Äú1-2 sentence practical explanation‚Äù
}]`;

```
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 2000,
                    messages: [{
                        role: 'user',
                        content: [...imageContents, { type: 'text', text: prompt }]
                    }]
                })
            });

            const data = await response.json();
            const text = data.content.find(c => c.type === 'text')?.text || '[]';
            const jsonMatch = text.match(/\[[\s\S]*\]/);
            const wines = jsonMatch ? JSON.parse(jsonMatch[0]) : [];

            if (wines.length === 0) {
                throw new Error('No wines found');
            }

            displayResults(wines);
        } catch (err) {
            document.getElementById('errorSection').innerHTML = `
                <div class="error-card">
                    Failed to analyze. Please try again or upload clearer images.
                </div>
            `;
        } finally {
            document.getElementById('loadingSection').innerHTML = '';
        }
    }

    function displayResults(wines) {
        const html = `
            <div class="section-header">Top 5 by Value</div>
            ${wines.map((wine, i) => {
                const rankClass = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
                return `
                    <div class="wine-card">
                        <div class="wine-rank">
                            <div class="rank-badge ${rankClass}">${wine.rank || i+1}</div>
                            <div class="wine-info">
                                <h3>${wine.name}</h3>
                                <div class="wine-meta">${wine.producer} ‚Ä¢ ${wine.vintage}</div>
                                <div class="wine-meta">${wine.region}${wine.classification ? ' ‚Ä¢ ' + wine.classification : ''}</div>
                                <div class="wine-price">¬£${wine.price}</div>
                            </div>
                        </div>
                        <div class="wine-bars">
                            <div class="bar-item">
                                <div class="bar-label">
                                    <span>Quality</span>
                                    <span>${wine.qualityScore}/100</span>
                                </div>
                                <div class="bar-track">
                                    <div class="bar-fill bar-quality" style="width:${wine.qualityScore}%"></div>
                                </div>
                            </div>
                            <div class="bar-item">
                                <div class="bar-label">
                                    <span>Value</span>
                                    <span>${wine.valueScore}/100</span>
                                </div>
                                <div class="bar-track">
                                    <div class="bar-fill bar-value" style="width:${wine.valueScore}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="wine-why"><strong>Why:</strong> ${wine.why}</div>
                    </div>
                `;
            }).join('')}
            <button class="camera-btn" onclick="resetApp()" style="margin-top:20px;">Scan Another List</button>
        `;
        document.getElementById('resultsSection').innerHTML = html;
    }

    document.getElementById('historyBtn').addEventListener('click', () => {
        alert('History feature coming soon!');
    });

    updateAdventureDisplay();
</script>
```

</body>
</html>
