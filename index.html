<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Wine Analyzer</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIldpbmUgVmFsdWUgQW5hbHl6ZXIiLAogICJzaG9ydF9uYW1lIjogIldpbmUiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAwMDAwMCIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDAwMDAiLAogICJpY29ucyI6IFt7CiAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NjaXJjbGUgY3g9JzUwJyBjeT0nNTAnIHI9JzUwJyBmaWxsPSclMjMwMDAnLyUzRSUzQy9zdmclM0UiLAogICAgInNpemVzIjogIjE5MngxOTIiLAogICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICB9XQp9">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #000;
        color: #fff;
        overflow-x: hidden;
        padding-bottom: 80px;
    }

    .header {
        padding: 20px 20px 16px;
        background: #000;
        border-bottom: 1px solid #222;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .header h1 {
        font-size: 24px;
        font-weight: 600;
        letter-spacing: -0.5px;
    }

    .header p {
        font-size: 14px;
        color: #888;
        margin-top: 4px;
    }

    .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .adventure-card {
        background: #111;
        border-radius: 16px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid #222;
    }

    .adventure-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .adventure-title {
        font-size: 16px;
        font-weight: 600;
    }

    .adventure-level {
        font-size: 13px;
        color: #888;
        background: #1a1a1a;
        padding: 4px 12px;
        border-radius: 12px;
    }

    .slider-container {
        position: relative;
        margin: 20px 0;
    }

    .slider {
        width: 100%;
        height: 4px;
        background: #222;
        border-radius: 2px;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .slider-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: 11px;
        color: #666;
    }

    .preferences-box {
        background: #0a0a0a;
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
    }

    .preferences-box h3 {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .wine-types {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .wine-type {
        font-size: 13px;
        color: #ccc;
        line-height: 1.6;
    }

    .wine-type-label {
        font-size: 11px;
        color: #666;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .camera-section {
        margin: 20px 0;
    }

    .camera-btn {
        width: 100%;
        background: #fff;
        color: #000;
        border: none;
        border-radius: 16px;
        padding: 20px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: all 0.2s;
    }

    .camera-btn:active {
        transform: scale(0.98);
        background: #f0f0f0;
    }

    .camera-btn svg {
        width: 24px;
        height: 24px;
    }

    .upload-btn {
        background: #1a1a1a;
        color: #fff;
        margin-top: 12px;
        border: 1px solid #333;
    }

    .upload-btn:active {
        background: #222;
    }

    .preview-card {
        background: #111;
        border-radius: 16px;
        padding: 16px;
        margin: 20px 0;
        border: 1px solid #222;
    }

    .preview-image {
        width: 100%;
        border-radius: 12px;
        margin-bottom: 12px;
    }

    .preview-actions {
        display: flex;
        gap: 8px;
    }

    .btn-secondary {
        flex: 1;
        background: #1a1a1a;
        color: #fff;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 14px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
    }

    .loading-card {
        background: #111;
        border-radius: 16px;
        padding: 40px 20px;
        text-align: center;
        margin: 20px 0;
        border: 1px solid #222;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #222;
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 15px;
        color: #ccc;
        margin-bottom: 8px;
    }

    .loading-subtext {
        font-size: 13px;
        color: #666;
    }

    .wine-card {
        background: #111;
        border-radius: 16px;
        padding: 20px;
        margin: 12px 0;
        border: 1px solid #222;
    }

    .wine-rank {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 16px;
    }

    .rank-number {
        font-size: 32px;
        font-weight: 700;
        color: #fff;
        min-width: 40px;
    }

    .wine-info h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
        line-height: 1.3;
    }

    .wine-meta {
        font-size: 13px;
        color: #888;
        margin-bottom: 2px;
    }

    .wine-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-top: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-excellent { background: #0f3; color: #000; }
    .badge-good { background: #fff; color: #000; }
    .badge-fair { background: #fa0; color: #000; }
    .badge-premium { background: #666; color: #fff; }

    .wine-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin: 16px 0;
    }

    .stat-box {
        background: #0a0a0a;
        border-radius: 12px;
        padding: 12px;
        text-align: center;
    }

    .stat-label {
        font-size: 11px;
        color: #666;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 20px;
        font-weight: 700;
    }

    .wine-analysis {
        font-size: 14px;
        color: #aaa;
        line-height: 1.6;
        padding-top: 12px;
        border-top: 1px solid #1a1a1a;
    }

    .section-header {
        font-size: 13px;
        font-weight: 600;
        color: #888;
        margin: 24px 0 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .error-card {
        background: #1a0000;
        border: 1px solid #330000;
        border-radius: 16px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
    }

    .error-text {
        color: #ff4444;
        font-size: 14px;
    }

    #videoContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 1000;
        display: none;
    }

    #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .camera-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 30px 20px;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        display: flex;
        justify-content: center;
        gap: 20px;
    }

    .capture-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: #fff;
        border: 4px solid #000;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(255,255,255,0.3);
    }

    .capture-btn:active {
        transform: scale(0.95);
    }

    .close-camera {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0,0,0,0.5);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 24px;
        cursor: pointer;
        backdrop-filter: blur(10px);
    }

    input[type="file"] {
        display: none;
    }
</style>
```

</head>
<body>
    <div class="header">
        <h1>Wine Analyzer</h1>
        <p>Find the best value on any wine list</p>
    </div>

```
<div class="container">
    <div class="adventure-card">
        <div class="adventure-header">
            <div class="adventure-title">Adventure Mode</div>
            <div class="adventure-level" id="adventureLabel">Comfort Zone</div>
        </div>
        
        <div class="slider-container">
            <input type="range" min="1" max="5" value="1" class="slider" id="adventureSlider">
            <div class="slider-labels">
                <span>Safe</span>
                <span>Curious</span>
                <span>Explorer</span>
                <span>Brave</span>
                <span>Bold</span>
            </div>
        </div>

        <div class="preferences-box">
            <h3>Level 1 includes</h3>
            <div class="wine-types">
                <div>
                    <div class="wine-type-label">Reds</div>
                    <div class="wine-type" id="redsList">Pinot Noir, Gamay, Burgundy, Beaujolais</div>
                </div>
                <div>
                    <div class="wine-type-label">Whites</div>
                    <div class="wine-type" id="whitesList">Chablis, Sancerre, Grüner Veltliner</div>
                </div>
            </div>
        </div>
    </div>

    <div class="camera-section" id="uploadSection">
        <button class="camera-btn" id="cameraBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Take Photo
        </button>
        <button class="camera-btn upload-btn" id="uploadBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Upload from Gallery
        </button>
        <input type="file" accept="image/*" id="fileInput">
    </div>

    <div id="previewSection"></div>
    <div id="loadingSection"></div>
    <div id="errorSection"></div>
    <div id="resultsSection"></div>
</div>

<div id="videoContainer">
    <button class="close-camera" id="closeCamera">×</button>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <div class="camera-controls">
        <button class="capture-btn" id="captureBtn"></button>
    </div>
</div>

<script>
    const adventureLevels = {
        1: {
            label: "Comfort Zone",
            reds: ['pinot noir', 'gamay', 'burgundy', 'beaujolais'],
            whites: ['chablis', 'sancerre', 'gruner veltliner', 'grüner veltliner', 'pouilly-fumé'],
            boost: 1.2
        },
        2: {
            label: "Slightly Adventurous",
            reds: ['pinot noir', 'gamay', 'burgundy', 'beaujolais', 'loire red', 'chinon', 'bourgueil'],
            whites: ['chablis', 'sancerre', 'gruner veltliner', 'muscadet', 'picpoul', 'vermentino'],
            boost: 1.15
        },
        3: {
            label: "Exploring",
            reds: ['pinot noir', 'gamay', 'grenache', 'garnacha', 'rioja joven', 'chinon', 'valpolicella'],
            whites: ['chablis', 'sancerre', 'gruner veltliner', 'albariño', 'verdicchio', 'soave', 'fiano'],
            boost: 1.10
        },
        4: {
            label: "Medium Adventure",
            reds: ['barbera', 'dolcetto', 'merlot', 'sangiovese', 'valpolicella', 'montepulciano', 'zweigelt'],
            whites: ['white burgundy', 'chenin blanc', 'vouvray', 'savennières', 'viognier', 'roussanne'],
            boost: 1.05
        },
        5: {
            label: "Bold Explorer",
            reds: ['tempranillo', 'rioja', 'ribera del duero', 'nebbiolo', 'syrah', 'monastrell'],
            whites: ['white rhône', 'viognier', 'marsanne', 'roussanne', 'chardonnay', 'semillon'],
            boost: 1.0
        }
    };

    let currentAdventureLevel = 1;
    let stream = null;

    document.getElementById('adventureSlider').addEventListener('input', (e) => {
        currentAdventureLevel = parseInt(e.target.value);
        updateAdventureDisplay();
    });

    function updateAdventureDisplay() {
        const level = adventureLevels[currentAdventureLevel];
        document.getElementById('adventureLabel').textContent = level.label;
        document.getElementById('redsList').textContent = level.reds.slice(0, 4).join(', ');
        document.getElementById('whitesList').textContent = level.whites.slice(0, 4).join(', ');
        
        const slider = document.getElementById('adventureSlider');
        const percent = ((currentAdventureLevel - 1) / 4) * 100;
        slider.style.background = `linear-gradient(to right, #fff 0%, #fff ${percent}%, #222 ${percent}%, #222 100%)`;
    }

    document.getElementById('cameraBtn').addEventListener('click', openCamera);
    document.getElementById('uploadBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    document.getElementById('closeCamera').addEventListener('click', closeCamera);
    document.getElementById('captureBtn').addEventListener('click', capturePhoto);

    async function openCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            document.getElementById('video').srcObject = stream;
            document.getElementById('videoContainer').style.display = 'block';
        } catch (err) {
            alert('Camera access denied. Please use the upload option.');
        }
    }

    function closeCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        document.getElementById('videoContainer').style.display = 'none';
    }

    function capturePhoto() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        canvas.toBlob((blob) => {
            closeCamera();
            processImage(blob);
        }, 'image/jpeg', 0.95);
    }

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (file) {
            processImage(file);
        }
    }

    function processImage(imageFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
            showPreview(e.target.result);
            analyzeWineList(e.target.result);
        };
        reader.readAsDataURL(imageFile);
    }

    function showPreview(imageData) {
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('previewSection').innerHTML = `
            <div class="preview-card">
                <img src="${imageData}" class="preview-image" alt="Wine list">
                <div class="preview-actions">
                    <button class="btn-secondary" onclick="resetApp()">Retake</button>
                </div>
            </div>
        `;
    }

    function showLoading() {
        document.getElementById('loadingSection').innerHTML = `
            <div class="loading-card">
                <div class="spinner"></div>
                <div class="loading-text">Analyzing wine list</div>
                <div class="loading-subtext">This may take a moment</div>
            </div>
        `;
    }

    function showError(message) {
        document.getElementById('errorSection').innerHTML = `
            <div class="error-card">
                <div class="error-text">${message}</div>
            </div>
        `;
        document.getElementById('loadingSection').innerHTML = '';
    }

    async function analyzeWineList(imageData) {
        showLoading();
        document.getElementById('errorSection').innerHTML = '';
        document.getElementById('resultsSection').innerHTML = '';

        try {
            const ocrResponse = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'image',
                                source: {
                                    type: 'base64',
                                    media_type: 'image/jpeg',
                                    data: imageData.split(',')[1]
                                }
                            },
                            {
                                type: 'text',
                                text: `Extract all wines from this wine list. For each wine, identify: wine name, producer/château, region/appellation, vintage (year), price, any quality indicators (Grand Cru, Premier Cru, etc.). Return ONLY a JSON array: [{"name": "Wine Name", "producer": "Producer", "region": "Region", "vintage": "2020", "price": "45.00", "classification": "Grand Cru"}]`
                            }
                        ]
                    }]
                })
            });

            const ocrData = await ocrResponse.json();
            let extractedWines = [];
            
            try {
                const textContent = ocrData.content.find(c => c.type === 'text')?.text || '[]';
                const jsonMatch = textContent.match(/\[[\s\S]*\]/);
                extractedWines = jsonMatch ? JSON.parse(jsonMatch[0]) : [];
            } catch (e) {
                extractedWines = [];
            }

            if (extractedWines.length === 0) {
                showError('Could not extract wines from image. Please try a clearer photo.');
                return;
            }

            const analyzedWines = await Promise.all(
                extractedWines.slice(0, 6).map(async (wine) => {
                    try {
                        const analysisResponse = await fetch('https://api.anthropic.com/v1/messages', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: 'claude-sonnet-4-20250514',
                                max_tokens: 1000,
                                messages: [{
                                    role: 'user',
                                    content: `Analyze this wine: ${wine.name}, ${wine.producer}, ${wine.region}, ${wine.vintage}, £${wine.price}. Rate quality 1-100 based on region, producer, vintage, classification. Return ONLY: {"qualityScore": 85, "valueScore": 75, "marketPrice": "55.00", "analysis": "Brief analysis"}`
                                }],
                                tools: [{ type: "web_search_20250305", name: "web_search" }]
                            })
                        });

                        const analysisData = await analysisResponse.json();
                        let scores = { qualityScore: 70, valueScore: 60, marketPrice: wine.price, analysis: 'Analysis unavailable' };
                        
                        try {
                            const analysisText = analysisData.content.find(c => c.type === 'text')?.text || '{}';
                            const jsonMatch = analysisText.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                scores = { ...scores, ...JSON.parse(jsonMatch[0]) };
                            }
                        } catch (e) {}

                        return { ...wine, ...scores, valueForMoney: calculateValueScore(scores.qualityScore, parseFloat(wine.price), parseFloat(scores.marketPrice), wine) };
                    } catch (e) {
                        return { ...wine, qualityScore: 0, valueScore: 0, valueForMoney: 0, analysis: 'Analysis failed' };
                    }
                })
            );

            displayResults(analyzedWines.sort((a, b) => b.valueForMoney - a.valueForMoney));
        } catch (err) {
            showError('Failed to analyze wine list. Please try again.');
        }
    }

    function calculateValueScore(quality, listPrice, marketPrice, wine) {
        const priceRatio = marketPrice / listPrice;
        const qualityWeight = quality / 100;
        let baseScore = (qualityWeight * 50) + (priceRatio * 50);
        
        const level = adventureLevels[currentAdventureLevel];
        const wineLower = `${wine.name} ${wine.region}`.toLowerCase();
        const isPreferred = level.reds.some(p => wineLower.includes(p)) || level.whites.some(p => wineLower.includes(p));
        
        if (isPreferred) {
            baseScore = Math.min(100, baseScore * level.boost);
        }
        
        return Math.round(baseScore);
    }

    function getValueBadge(score) {
        if (score >= 80) return { text: 'Excellent Value', cls: 'badge-excellent' };
        if (score >= 65) return { text: 'Good Value', cls: 'badge-good' };
        if (score >= 50) return { text: 'Fair Value', cls: 'badge-fair' };
        return { text: 'Premium Price', cls: 'badge-premium' };
    }

    function displayResults(wines) {
        document.getElementById('loadingSection').innerHTML = '';
        
        const html = `
            <div class="section-header">Ranked by Value</div>
            ${wines.map((wine, i) => {
                const badge = getValueBadge(wine.valueForMoney);
                return `
                    <div class="wine-card">
                        <div class="wine-rank">
                            <div class="rank-number">${i + 1}</div>
                            <div class="wine-info">
                                <h3>${wine.name}</h3>
                                <div class="wine-meta">${wine.producer} • ${wine.vintage}</div>
                                <div class="wine-meta">${wine.region}${wine.classification ? ' • ' + wine.classification : ''}</div>
                                <span class="wine-badge ${badge.cls}">${badge.text}</span>
                            </div>
                        </div>
                        <div class="wine-stats">
                            <div class="stat-box">
                                <div class="stat-label">Quality</div>
                                <div class="stat-value">${wine.qualityScore}</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Value</div>
                                <div class="stat-value">${wine.valueForMoney}</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Price</div>
                                <div class="stat-value">£${wine.price}</div>
                            </div>
                        </div>
                        <div class="wine-analysis">${wine.analysis}</div>
                    </div>
                `;
            }).join('')}
        `;
        
        document.getElementById('resultsSection').innerHTML = html;
    }

    function resetApp() {
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('previewSection').innerHTML = '';
        document.getElementById('loadingSection').innerHTML = '';
        document.getElementById('errorSection').innerHTML = '';
        document.getElementById('resultsSection').innerHTML = '';
        document.getElementById('fileInput').value = '';
    }

    updateAdventureDisplay();
</script>
```

</body>
</html>
