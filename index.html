<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Wine Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #000;
        color: #fff;
        overflow-x: hidden;
        padding-bottom: 80px;
    }

    .header {
        padding: 20px 20px 16px;
        background: #000;
        border-bottom: 1px solid #222;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left h1 {
        font-size: 24px;
        font-weight: 600;
        letter-spacing: -0.5px;
    }

    .header-left p {
        font-size: 14px;
        color: #888;
        margin-top: 4px;
    }

    .history-btn {
        background: #1a1a1a;
        border: 1px solid #333;
        color: #fff;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
    }

    .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .adventure-card {
        background: #111;
        border-radius: 16px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid #222;
    }

    .adventure-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .adventure-title {
        font-size: 16px;
        font-weight: 600;
    }

    .adventure-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 16px 0;
    }

    .adventure-option {
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 12px;
        padding: 16px 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .adventure-option.active {
        background: #fff;
        color: #000;
        border-color: #fff;
    }

    .adventure-option .option-emoji {
        font-size: 24px;
        margin-bottom: 4px;
    }

    .adventure-option .option-label {
        font-size: 13px;
        font-weight: 600;
    }

    .preferences-box {
        background: #0a0a0a;
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
    }

    .preferences-box h3 {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .wine-types {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .wine-type {
        font-size: 13px;
        color: #ccc;
        line-height: 1.6;
    }

    .wine-type-label {
        font-size: 11px;
        color: #666;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .camera-btn {
        width: 100%;
        background: #fff;
        color: #000;
        border: none;
        border-radius: 16px;
        padding: 20px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: all 0.2s;
        margin: 20px 0 12px;
    }

    .camera-btn:active {
        transform: scale(0.98);
        background: #f0f0f0;
    }

    .camera-btn svg {
        width: 24px;
        height: 24px;
    }

    .upload-btn {
        background: #1a1a1a;
        color: #fff;
        border: 1px solid #333;
    }

    .upload-btn:active {
        background: #222;
    }

    .captured-pages {
        margin: 20px 0;
    }

    .page-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 16px;
    }

    .page-thumbnail {
        position: relative;
        aspect-ratio: 3/4;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #333;
    }

    .page-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .page-number {
        position: absolute;
        top: 4px;
        left: 4px;
        background: rgba(0,0,0,0.7);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .remove-page {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(255,0,0,0.8);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 16px;
        cursor: pointer;
    }

    .page-actions {
        display: flex;
        gap: 8px;
    }

    .btn-analyze {
        flex: 2;
        background: #fff;
        color: #000;
        border: none;
        border-radius: 12px;
        padding: 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-add-more {
        flex: 1;
        background: #1a1a1a;
        color: #fff;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
    }

    #videoContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 1000;
        display: none;
    }

    #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }

    .focus-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 60%;
        border: 2px solid rgba(255,255,255,0.5);
        border-radius: 8px;
    }

    .quality-indicator {
        position: absolute;
        top: 80px;
        left: 20px;
        right: 20px;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(10px);
        padding: 16px;
        border-radius: 12px;
        pointer-events: none;
    }

    .quality-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .status-icon {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .status-good { background: #0f3; }
    .status-warning { background: #fa0; }

    .status-text {
        font-size: 14px;
        font-weight: 600;
    }

    .quality-tips {
        font-size: 12px;
        color: #ccc;
        line-height: 1.4;
    }

    .page-counter {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(10px);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        pointer-events: none;
    }

    .camera-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 30px 20px;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
    }

    .capture-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: #fff;
        border: 4px solid #000;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(255,255,255,0.3);
    }

    .capture-btn:active {
        transform: scale(0.95);
    }

    .capture-btn.disabled {
        background: #666;
        cursor: not-allowed;
    }

    .done-btn {
        background: #0f3;
        color: #000;
        border: none;
        border-radius: 12px;
        padding: 12px 24px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
    }

    .close-camera {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0,0,0,0.5);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 24px;
        cursor: pointer;
        backdrop-filter: blur(10px);
    }

    .zoom-controls {
        position: absolute;
        bottom: 120px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .zoom-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(10px);
        color: #fff;
        border: 1px solid rgba(255,255,255,0.2);
        font-size: 20px;
        cursor: pointer;
    }

    .loading-card {
        background: #111;
        border-radius: 16px;
        padding: 40px 20px;
        text-align: center;
        margin: 20px 0;
        border: 1px solid #222;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #222;
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 15px;
        margin-bottom: 8px;
    }

    .loading-subtext {
        font-size: 13px;
        color: #666;
    }

    .wine-card {
        background: #111;
        border-radius: 16px;
        padding: 20px;
        margin: 12px 0;
        border: 1px solid #222;
    }

    .wine-rank {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 16px;
    }

    .rank-badge {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fff, #ddd);
        color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        flex-shrink: 0;
    }

    .rank-badge.top1 { background: linear-gradient(135deg, #ffd700, #ffed4e); }
    .rank-badge.top2 { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); }
    .rank-badge.top3 { background: linear-gradient(135deg, #cd7f32, #e8b67e); }

    .wine-info h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
        line-height: 1.3;
    }

    .wine-meta {
        font-size: 13px;
        color: #888;
        margin-bottom: 2px;
    }

    .wine-price {
        font-size: 20px;
        font-weight: 700;
        color: #fff;
        margin-top: 8px;
    }

    .wine-bars {
        margin: 16px 0;
    }

    .bar-item {
        margin-bottom: 12px;
    }

    .bar-label {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #888;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .bar-track {
        height: 6px;
        background: #1a1a1a;
        border-radius: 3px;
        overflow: hidden;
    }

    .bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .bar-quality { background: #fff; }
    .bar-value { background: #0f3; }

    .wine-why {
        font-size: 14px;
        color: #aaa;
        line-height: 1.6;
        padding-top: 12px;
        border-top: 1px solid #1a1a1a;
    }

    .section-header {
        font-size: 13px;
        font-weight: 600;
        color: #888;
        margin: 24px 0 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .error-card {
        background: #1a0000;
        border: 1px solid #330000;
        border-radius: 16px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
        color: #ff4444;
    }

    .history-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.95);
        z-index: 2000;
        display: none;
        overflow-y: auto;
    }

    .history-modal.active {
        display: block;
    }

    .history-header {
        position: sticky;
        top: 0;
        background: #000;
        padding: 20px;
        border-bottom: 1px solid #222;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .history-item {
        background: #111;
        border-radius: 12px;
        padding: 16px;
        margin: 12px 20px;
        border: 1px solid #222;
        cursor: pointer;
    }

    .history-date {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
    }

    .history-wines {
        font-size: 14px;
        color: #ccc;
    }

    input[type="file"] {
        display: none;
    }

    .zoom-indicator {
        position: absolute;
        bottom: 180px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(10px);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        pointer-events: none;
    }
</style>
```

</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Wine Analyzer</h1>
            <p>Find the best value on any wine list</p>
        </div>
        <button class="history-btn" id="historyBtn">History</button>
    </div>

```
<div class="container">
    <div class="adventure-card">
        <div class="adventure-header">
            <div class="adventure-title">Adventure Mode</div>
        </div>
        
        <div class="adventure-options">
            <div class="adventure-option active" data-level="1">
                <div class="option-emoji">üõ°Ô∏è</div>
                <div class="option-label">Safe</div>
            </div>
            <div class="adventure-option" data-level="2">
                <div class="option-emoji">üß≠</div>
                <div class="option-label">Curious</div>
            </div>
            <div class="adventure-option" data-level="3">
                <div class="option-emoji">üó∫Ô∏è</div>
                <div class="option-label">Explorer</div>
            </div>
        </div>

        <div class="preferences-box">
            <h3 id="preferencesTitle">Safe includes</h3>
            <div class="wine-types">
                <div>
                    <div class="wine-type-label">Reds</div>
                    <div class="wine-type" id="redsList">Pinot Noir, Gamay, Beaujolais</div>
                </div>
                <div>
                    <div class="wine-type-label">Whites</div>
                    <div class="wine-type" id="whitesList">Chablis, Sancerre, Gr√ºner Veltliner</div>
                </div>
            </div>
        </div>
    </div>

    <div id="uploadSection">
        <button class="camera-btn" id="cameraBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Capture Wine List
        </button>
        <button class="camera-btn upload-btn" id="uploadBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Upload Photos
        </button>
        <input type="file" accept="image/*" multiple id="fileInput">
    </div>

    <div id="capturedSection"></div>
    <div id="loadingSection"></div>
    <div id="errorSection"></div>
    <div id="resultsSection"></div>
</div>

<div id="videoContainer">
    <button class="close-camera" id="closeCamera">√ó</button>
    <div class="page-counter" id="pageCounter">Page 1</div>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    
    <div class="camera-overlay">
        <div class="focus-frame"></div>
        <div class="quality-indicator" id="qualityIndicator">
            <div class="quality-status">
                <div class="status-icon" id="statusIcon"></div>
                <div class="status-text" id="statusText">Analyzing...</div>
            </div>
            <div class="quality-tips" id="qualityTips">Position menu within frame</div>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomOut">‚àí</button>
    </div>
    
    <div class="zoom-indicator" id="zoomIndicator" style="display:none;">1.0x</div>

    <div class="camera-controls">
        <button class="done-btn" id="doneBtn" style="display:none;">Done</button>
        <button class="capture-btn" id="captureBtn"></button>
    </div>
</div>

<div class="history-modal" id="historyModal">
    <div class="history-header">
        <h2>Scan History</h2>
        <button class="close-camera" id="closeHistory">√ó</button>
    </div>
    <div id="historyList"></div>
</div>

<script>
    const adventureLevels = {
        1: {
            label: "Safe",
            reds: ['pinot noir', 'gamay', 'burgundy', 'beaujolais', 'loire red', 'chinon'],
            whites: ['chablis', 'sancerre', 'gruner veltliner', 'gr√ºner veltliner', 'pouilly-fum√©', 'muscadet'],
            boost: 1.2
        },
        2: {
            label: "Curious",
            reds: ['pinot noir', 'gamay', 'grenache', 'garnacha', 'barbera', 'dolcetto', 'valpolicella', 'chinon', 'rioja joven'],
            whites: ['chablis', 'sancerre', 'gruner veltliner', 'albari√±o', 'vermentino', 'verdicchio', 'soave', 'fiano', 'chenin blanc'],
            boost: 1.1
        },
        3: {
            label: "Explorer",
            reds: ['tempranillo', 'rioja', 'nebbiolo', 'sangiovese', 'merlot', 'syrah', 'monastrell', 'montepulciano', 'zweigelt', 'barbera'],
            whites: ['viognier', 'roussanne', 'marsanne', 'white burgundy', 'chardonnay', 'semillon', 'vouvray', 'savenni√®res'],
            boost: 1.0
        }
    };

    let currentAdventureLevel = 1;
    let stream = null;
    let currentZoom = 1;
    let videoTrack = null;
    let qualityCheckInterval = null;
    let capturedPages = [];
    let scanHistory = JSON.parse(localStorage.getItem('wineHistory') || '[]');

    // Adventure mode selection
    document.querySelectorAll('.adventure-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.adventure-option').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            currentAdventureLevel = parseInt(this.dataset.level);
            updateAdventureDisplay();
        });
    });

    function updateAdventureDisplay() {
        const level = adventureLevels[currentAdventureLevel];
        document.getElementById('preferencesTitle').textContent = `${level.label} includes`;
        document.getElementById('redsList').textContent = level.reds.slice(0, 3).join(', ');
        document.getElementById('whitesList').textContent = level.whites.slice(0, 3).join(', ');
    }

    // History functionality
    document.getElementById('historyBtn').addEventListener('click', () => {
        showHistory();
    });

    document.getElementById('closeHistory').addEventListener('click', () => {
        document.getElementById('historyModal').classList.remove('active');
    });

    function showHistory() {
        const modal = document.getElementById('historyModal');
        const list = document.getElementById('historyList');
        
        if (scanHistory.length === 0) {
            list.innerHTML = '<div style="padding:40px;text-align:center;color:#666;">No scans yet</div>';
        } else {
            list.innerHTML = scanHistory.slice(0, 20).map((scan, i) => `
                <div class="history-item" onclick="loadHistoryScan(${i})">
                    <div class="history-date">${new Date(scan.date).toLocaleDateString()} ${new Date(scan.date).toLocaleTimeString()}</div>
                    <div class="history-wines">${scan.wines.length} wines analyzed ‚Ä¢ Top pick: ${scan.wines[0]?.name || 'N/A'}</div>
                </div>
            `).join('');
        }
        
        modal.classList.add('active');
    }

    function loadHistoryScan(index) {
        const scan = scanHistory[index];
        displayResults(scan.wines);
        document.getElementById('historyModal').classList.remove('active');
    }

    function saveToHistory(wines) {
        scanHistory.unshift({
            date: new Date().toISOString(),
            wines: wines
        });
        scanHistory = scanHistory.slice(0, 20);
        localStorage.setItem('wineHistory', JSON.stringify(scanHistory));
    }

    document.getElementById('cameraBtn').addEventListener('click', openCamera);
    document.getElementById('uploadBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    document.getElementById('closeCamera').addEventListener('click', closeCamera);
    document.getElementById('captureBtn').addEventListener('click', capturePhoto);
    document.getElementById('doneBtn').addEventListener('click', finishCapturing);
    document.getElementById('zoomIn').addEventListener('click', () => adjustZoom(0.2));
    document.getElementById('zoomOut').addEventListener('click', () => adjustZoom(-0.2));

    async function openCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            });
            
            const video = document.getElementById('video');
            video.srcObject = stream;
            document.getElementById('videoContainer').style.display = 'block';
            updatePageCounter();

            videoTrack = stream.getVideoTracks()[0];
            const capabilities = videoTrack.getCapabilities();
            
            if (capabilities.zoom) {
                currentZoom = videoTrack.getSettings().zoom || 1;
            }

            video.addEventListener('loadedmetadata', () => {
                startQualityMonitoring();
            });

        } catch (err) {
            alert('Camera access denied. Please use the upload option.');
        }
    }

    function closeCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        if (qualityCheckInterval) {
            clearInterval(qualityCheckInterval);
        }
        document.getElementById('videoContainer').style.display = 'none';
        document.getElementById('doneBtn').style.display = 'none';
        currentZoom = 1;
    }

    function updatePageCounter() {
        document.getElementById('pageCounter').textContent = `Page ${capturedPages.length + 1}`;
    }

    async function adjustZoom(delta) {
        if (!videoTrack) return;

        const capabilities = videoTrack.getCapabilities();
        if (!capabilities.zoom) return;

        const newZoom = Math.max(
            capabilities.zoom.min,
            Math.min(capabilities.zoom.max, currentZoom + delta)
        );

        await videoTrack.applyConstraints({
            advanced: [{ zoom: newZoom }]
        });

        currentZoom = newZoom;
        
        const indicator = document.getElementById('zoomIndicator');
        indicator.textContent = `${newZoom.toFixed(
```
